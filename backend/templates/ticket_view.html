{% extends "layout.html" %}
{% block title %}Ticket #{{ T.ticket_no }} - IT Ticketing Portal{% endblock %}

{% block head %}
<style>
    /* Page Header */
    .ticket-header {
        background: var(--bg-card-final);
        border: 1px solid var(--border-final);
        border-radius: var(--card-radius);
        padding: 32px;
        box-shadow: 0 2px 8px var(--shadow-final);
        margin-bottom: 24px;
    }

    .ticket-header-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .ticket-id-section h1 {
        margin: 0;
        font-size: 32px;
        font-weight: 700;
        color: var(--text-main);
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .ticket-id-section h1 i {
        color: var(--brand);
    }

    .ticket-number {
        font-family: 'Courier New', monospace;
        color: var(--brand);
    }

    /* Status Badge */
    .status-badge-large {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-open { background: #fef3c7; color: #92400e; }
    .status-progress { background: #dbeafe; color: #1e40af; }
    .status-resolved { background: #d1fae5; color: #065f46; }
    .status-closed { background: #e5e7eb; color: #374151; }
    .status-re-open { background: #fecaca; color: #991b1b; }       /* Red */
    .status-not-open-yet { background: #e5e7eb; color: #374151; } /* Neutral gray */


    /* Meta Tags */
    .ticket-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-top: 16px;
    }

    .meta-chip {
        padding: 8px 14px;
        background: var(--bg-main);
        border: 1px solid var(--border-final);
        border-radius: 8px;
        font-size: 13px;
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--text-main);
    }

    .meta-chip i {
        color: var(--brand);
    }

    .meta-chip.sla-met { border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
    .meta-chip.sla-breached { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
    .meta-chip.sla-at-risk { border-color: #f59e0b; background: rgba(245, 158, 11, 0.1); }

    /* Description */
    .ticket-description {
        margin-top: 20px;
        padding: 20px;
        background: var(--bg-main);
        border-radius: 8px;
        line-height: 1.7;
        color: var(--text-main);
    }

    .description-label {
        font-weight: 600;
        font-size: 14px;
        color: var(--text-muted-final);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        display: block;
    }

    /* Attachments */
    .attachments-section {
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid var(--border-final);
    }

    .attachments-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
        margin-top: 12px;
    }

    .attachment-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        background: var(--bg-main);
        border: 1px solid var(--border-final);
        border-radius: 8px;
        text-decoration: none;
        color: var(--text-main);
        transition: all 0.3s ease;
    }

    .attachment-item:hover {
        border-color: var(--brand);
        background: rgba(10, 75, 120, 0.05);
        color: var(--brand);
    }

    .attachment-item i {
        font-size: 20px;
        color: var(--brand);
    }

    /* Update Panel */
    .update-panel {
        background: var(--bg-card-final);
        border: 1px solid var(--border-final);
        border-radius: var(--card-radius);
        padding: 32px;
        box-shadow: 0 2px 8px var(--shadow-final);
        margin-bottom: 24px;
    }

    .panel-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-main);
        margin: 0 0 24px 0;
        display: flex;
        align-items: center;
        gap: 10px;
        padding-bottom: 16px;
        border-bottom: 2px solid var(--border-final);
    }

    .panel-title i {
        color: var(--brand);
    }

    /* Form */
    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        color: var(--text-main);
        margin-bottom: 8px;
        font-size: 14px;
    }

    .form-control, .form-select {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid var(--border-final);
        border-radius: 8px;
        background: var(--bg-main);
        color: var(--text-main);
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: var(--brand);
        box-shadow: 0 0 0 3px rgba(10, 75, 120, 0.1);
    }

    textarea.form-control {
        resize: vertical;
        min-height: 100px;
    }

    /* Form Actions */
    .form-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 2px solid var(--border-final);
    }

    .btn-back {
        color: var(--text-muted-final);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: color 0.3s ease;
    }

    .btn-back:hover {
        color: var(--brand);
    }

    .btn-submit {
        padding: 12px 32px;
        background: var(--brand);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 12px rgba(10, 75, 120, 0.3);
    }

    .btn-submit:hover {
        background: var(--brand-light);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(10, 75, 120, 0.4);
    }

    /* Comments Section */
    .comments-section {
        background: var(--bg-card-final);
        border: 1px solid var(--border-final);
        border-radius: var(--card-radius);
        padding: 32px;
        box-shadow: 0 2px 8px var(--shadow-final);
    }

    .comment-item {
        padding: 20px;
        background: var(--bg-main);
        border: 1px solid var(--border-final);
        border-radius: 10px;
        margin-bottom: 16px;
        transition: all 0.3s ease;
    }

    .comment-item:hover {
        border-color: var(--brand);
        box-shadow: 0 2px 8px var(--shadow-final);
    }

    .comment-item:last-child {
        margin-bottom: 0;
    }

    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .comment-author {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        color: var(--text-main);
    }

    .comment-author i {
        font-size: 20px;
        color: var(--brand);
    }

    .comment-time {
        font-size: 12px;
        color: var(--text-muted-final);
    }

    .comment-text {
        color: var(--text-main);
        line-height: 1.6;
        margin: 0;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-muted-final);
    }

    .empty-state i {
        font-size: 48px;
        opacity: 0.3;
        margin-bottom: 12px;
    }

    /* Priority Badge */
    .priority-badge {
        padding: 5px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .priority-low { background: #d1fae5; color: #065f46; }
    .priority-medium { background: #fef3c7; color: #92400e; }
    .priority-high { background: #fed7aa; color: #9a3412; }
    .priority-critical { background: #fecaca; color: #991b1b; }

    /* Responsive */
    @media (max-width: 768px) {
        .ticket-header {
            padding: 20px;
        }

        .ticket-header-top {
            flex-direction: column;
        }

        .ticket-id-section h1 {
            font-size: 24px;
        }

        .ticket-meta {
            flex-direction: column;
        }

        .meta-chip {
            width: 100%;
        }

        .form-actions {
            flex-direction: column;
            gap: 16px;
        }

        .btn-back {
            width: 100%;
            justify-content: center;
        }

        .btn-submit {
            width: 100%;
            justify-content: center;
        }
    }

    /* Alert Box */
    .alert-box {
        padding: 14px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .alert-box.warning {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.3);
        color: #d97706;
    }

    .alert-box.danger {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        color: #dc2626;
    }

    .alert-box i {
        font-size: 20px;
    }
</style>
{% endblock %}

{% block content %}

<!-- Ticket Header -->
<div class="ticket-header">
    <div class="ticket-header-top">
        <div class="ticket-id-section">
            <h1>
                <i class="fa-solid fa-ticket"></i>
                <span class="ticket-number">#{{ T.ticket_no }}</span>
            </h1>
        </div>
        <div>
            <span class="status-badge-large status-{{ T.status|lower|replace(' ', '-') }}">
                {{ T.status }}
            </span>
        </div>
    </div>

    <!-- Meta Information -->
    <div class="ticket-meta">
        <div class="meta-chip">
            <i class="fa-solid fa-user"></i>
            <span><strong>Created by:</strong> {{ T.user.name if T.user else 'Unknown' }}</span>
        </div>

        <div class="meta-chip">
            <i class="fa-solid fa-tag"></i>
            <span><strong>Type:</strong> {{ T.ticket_type or 'N/A' }}</span>
        </div>

        <div class="meta-chip">
            <i class="fa-solid fa-folder"></i>
            <span><strong>Category:</strong> {{ T.category or 'Uncategorized' }}</span>
        </div>

        <div class="meta-chip">
            <i class="fa-solid fa-flag"></i>
            <span class="priority-badge priority-{{ T.priority|lower }}">{{ T.priority }}</span>
        </div>

        <div class="meta-chip">
            <i class="fa-solid fa-clock"></i>
            <span>{{ T.created_at.strftime("%b %d, %Y at %I:%M %p") if T.created_at else 'N/A' }}</span>
        </div>

        {% if T.due_date %}
        <div class="meta-chip">
            <i class="fa-solid fa-hourglass-half"></i>
            <span><strong>Due:</strong> {{ T.due_date.strftime("%b %d, %Y at %I:%M %p") }}</span>
        </div>
        {% endif %}

        {% if T.sla_state %}
        <div class="meta-chip sla-{{ T.sla_state|lower|replace(' ', '-') }}">
            <i class="fa-solid fa-shield-halved"></i>
            <span><strong>SLA:</strong> {{ T.sla_state }}</span>
        </div>
        {% endif %}

        {% if T.assignee or T.assignee_name %}
        <div class="meta-chip">
            <i class="fa-solid fa-user-check"></i>
            <span><strong>Assigned to:</strong> 
                {% if T.assignee %}
                    {{ T.assignee.name }}
                {% elif T.assignee_name %}
                    {{ T.assignee_name }}
                {% endif %}
            </span>
        </div>
        {% endif %}
    </div>

    <!-- Description -->
    <div class="ticket-description">
        <span class="description-label">Description</span>
        {{ T.description }}
    </div>

    <!-- Attachments -->
    {% if attachments %}
    <div class="attachments-section">
        <span class="description-label">
            <i class="fa-solid fa-paperclip"></i> Attachments ({{ attachments|length }})
        </span>
        <div class="attachments-grid">
            {% for att in attachments %}
            <a href="{{ url_for('uploaded_file', filename=att.filename) }}" 
               class="attachment-item"
               target="_blank">
                <i class="fa-solid fa-file"></i>
                <span>{{ att.filename }}</span>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- SLA Warning -->
{% if T.sla_state == 'Breached' %}
<div class="alert-box danger">
    <i class="fa-solid fa-exclamation-triangle"></i>
    <span><strong>SLA Breached:</strong> This ticket has exceeded its service level agreement deadline.</span>
</div>
{% elif T.sla_state == 'At Risk' %}
<div class="alert-box warning">
    <i class="fa-solid fa-clock"></i>
    <span><strong>SLA At Risk:</strong> This ticket is approaching its deadline. Please take action soon.</span>
</div>
{% endif %}

<!-- Update Panel (Admin/Assignee Only) -->
{% if current_user.role in ["admin", "assignee"] %}
<div class="update-panel">
    <h2 class="panel-title">
        <i class="fa-solid fa-pen-to-square"></i>
        Update Ticket
    </h2>

    <form method="POST" enctype="multipart/form-data" id="updateForm">
        
        <!-- Admin-only: Assign To -->
        {% if current_user.role == "admin" %}
        <div class="form-group">
            <label class="form-label" for="assignee">
                <i class="fa-solid fa-user-plus"></i> Assign To
            </label>
            <select name="assignee_id" id="assignee" class="form-select">
                <option value="">— Unassigned —</option>
                {% for a in assignees %}
                <option value="{{ a.id }}" {% if T.assignee_id == a.id %}selected{% endif %}>
                    {{ a.name }} ({{ a.role|capitalize }})
                </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}

        <!-- Status -->
        <div class="form-group">
            <label class="form-label" for="status">
                <i class="fa-solid fa-circle-check"></i> Status
            </label>
            <select name="status" id="status" class="form-select">

            {% if current_user.role == "admin" %}
              <option value="Not Open Yet" {% if T.status=="Not Open Yet" %}selected{% endif %}>
                  Not Open Yet
              </option>
            {% endif %}

              <option value="Open" {% if T.status=="Open" %}selected{% endif %}>Open</option>
              <option value="In Progress" {% if T.status=="In Progress" %}selected{% endif %}>In Progress</option>
              <option value="Resolved" {% if T.status=="Resolved" %}selected{% endif %}>Resolved</option>
              <option value="Closed" {% if T.status=="Closed" %}selected{% endif %}>Closed</option>

            {% if current_user.role == "admin" %}
                <option value="Re-Open" {% if T.status=="Re-Open" %}selected{% endif %}>
                    Re-Open
                </option>
            {% endif %}

            </select>

        </div>

        <!-- Admin-only: Priority -->
        {% if current_user.role == "admin" %}
        <div class="form-group">
            <label class="form-label" for="priority">
                <i class="fa-solid fa-flag"></i> Priority
            </label>
            <select name="priority" id="priority" class="form-select">
                <option value="Low" {% if T.priority=="Low" %}selected{% endif %}>Low</option>
                <option value="Medium" {% if T.priority=="Medium" %}selected{% endif %}>Medium</option>
                <option value="High" {% if T.priority=="High" %}selected{% endif %}>High</option>
                <option value="Critical" {% if T.priority=="Critical" %}selected{% endif %}>Critical</option>
            </select>
        </div>
        {% endif %}

        <!-- Attachment Upload -->
        <div class="form-group">
            <label class="form-label" for="attachment">
                <i class="fa-solid fa-paperclip"></i> Upload Attachment
            </label>
            <input type="file" 
                   name="attachment" 
                   id="attachment" 
                   class="form-control">
        </div>

        <!-- Comment/Message -->
        <div class="form-group">
            <label class="form-label" for="message">
                <i class="fa-solid fa-comment"></i> Add Comment or Update
            </label>
            <textarea name="message" 
                      id="message" 
                      class="form-control"
                      placeholder="Provide an update or add a comment..."></textarea>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <a href="{{ url_for('dashboard') }}" class="btn-back">
                <i class="fa-solid fa-arrow-left"></i>
                Back to Dashboard
            </a>
            <button type="submit" class="btn-submit" id="submitBtn">
                <i class="fa-solid fa-paper-plane"></i>
                Submit Update
            </button>
        </div>
    </form>
</div>
{% endif %}

<!-- Comments Section -->
<div class="comments-section">
    <h2 class="panel-title">
        <i class="fa-solid fa-comments"></i>
        Activity & Comments
    </h2>

    {% if comments %}
    <div class="comments-list">
        {% for c in comments %}
        <div class="comment-item">
            <div class="comment-header">
                <div class="comment-author">
                    <i class="fa-solid fa-user-circle"></i>
                    {{ c.user.name if c.user else "System" }}
                </div>
                <div class="comment-time">
                    {{ c.created_at.strftime("%b %d, %Y at %I:%M %p") if c.created_at else '' }}
                </div>
            </div>
            <p class="comment-text">{{ c.message }}</p>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fa-solid fa-comments"></i>
        <p>No comments or activity yet.</p>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>
(function() {
    'use strict';

    const form = document.getElementById('updateForm');
    const submitBtn = document.getElementById('submitBtn');

    if (form) {
        // Form validation
        form.addEventListener('submit', function(e) {
            const message = document.getElementById('message').value.trim();
            const status = document.getElementById('status').value;
            const attachment = document.getElementById('attachment').files.length;

            // Check if any changes were made
            const hasChanges = message || 
                              status !== '{{ T.status }}' || 
                              attachment > 0 ||
                              {% if current_user.role == "admin" %}
                              document.getElementById('assignee').value !== '{{ T.assignee_id if T.assignee_id else "" }}' ||
                              document.getElementById('priority').value !== '{{ T.priority }}'
                              {% else %}
                              false
                              {% endif %};

            if (!hasChanges) {
                e.preventDefault();
                window.showToast('No changes detected', 'info');
                return;
            }

            // Add loading state
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Submitting...';
            }
        });

        // Confirmation for closing ticket
        const statusSelect = document.getElementById('status');
        if (statusSelect) {
            statusSelect.addEventListener('change', function() {
                if (this.value === 'Closed') {
                    const confirmed = confirm('Are you sure you want to close this ticket? This will mark it as resolved.');
                    if (!confirmed) {
                        this.value = '{{ T.status }}';
                    }
                }
            });
        }
    }

    // Auto-scroll to comments if hash present
    if (window.location.hash === '#comments') {
        document.querySelector('.comments-section').scrollIntoView({ behavior: 'smooth' });
    }

})();
</script>
{% endblock %}